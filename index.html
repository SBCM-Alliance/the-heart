<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Heart | Global Liquidity Protocol</title>
    
    <!-- PyScript 2024.1.1 -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* --- Cyberpunk UI --- */
        body {
            background-color: #050505;
            color: #e0e0e0;
            font-family: 'Segoe UI', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: #ff4b4b; margin: 0; letter-spacing: 3px; text-shadow: 0 0 10px #ff4b4b; }
        .subtitle { color: #666; font-size: 0.8rem; margin-bottom: 20px; }

        /* --- HQ (The Heart) --- */
        .hq-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        .heart-icon {
            font-size: 4rem;
            animation: heartbeat 1.5s infinite;
            cursor: pointer;
            z-index: 20;
        }

        .pool-display {
            background: #111;
            border: 1px solid #ff4b4b;
            padding: 8px 24px;
            border-radius: 20px;
            margin-top: -10px;
            font-size: 1.2rem;
            color: #ff4b4b;
            box-shadow: 0 0 15px rgba(255, 75, 75, 0.2);
            font-family: monospace;
            z-index: 21;
        }

        /* --- Blocks Layout --- */
        .blocks-wrapper {
            display: flex;
            justify-content: center;
            gap: 12px;
            width: 100%;
            max-width: 800px;
            flex-wrap: nowrap; /* Ê®™‰∏¶„Å≥Âº∑Âà∂ */
        }

        .block-card {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            flex: 1;
            text-align: center;
            position: relative;
            transition: all 0.3s;
            min-width: 60px;
        }

        .block-card.predator { border-color: #d600ff; box-shadow: 0 0 10px rgba(214, 0, 255, 0.2); }
        .block-card.critical { border-color: #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); animation: shake 0.5s infinite; }

        .block-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; white-space: nowrap; }
        
        .vitality-track {
            height: 120px;
            background: #1a1a1a;
            width: 14px;
            margin: 0 auto;
            position: relative;
            border-radius: 10px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .vitality-fill {
            width: 100%;
            position: absolute;
            bottom: 0;
            transition: height 0.3s ease-out, background-color 0.3s;
        }

        .block-stats { font-size: 0.7rem; color: #888; margin-top: 8px; font-family: monospace; }

        /* --- Controls --- */
        .controls { margin-top: 40px; display: flex; gap: 20px; }
        .btn {
            background: #222; border: 1px solid #444; color: white;
            padding: 12px 24px; cursor: pointer; border-radius: 4px;
            font-weight: bold; font-size: 1rem;
            transition: all 0.1s;
        }
        .btn:hover { background: #333; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { 
            background: linear-gradient(45deg, #ff4b4b, #ff0000); 
            border: none; 
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }

        /* --- Log --- */
        #log-area {
            margin-top: 30px;
            height: 120px;
            width: 90%;
            max-width: 600px;
            overflow-y: auto;
            font-size: 0.7rem;
            color: #555;
            border-top: 1px solid #222;
            padding-top: 10px;
            font-family: monospace;
        }
        .log-entry { margin-bottom: 2px; }
        .c-purple { color: #d600ff; } /* ÊêæÂèñËâ≤ */
        .c-gold { color: #ffd700; }   /* Âæ¥ÂèéËâ≤ */
        .c-red { color: #ff4b4b; }    /* ÊïëÊ∏àËâ≤ */

        /* --- Animations --- */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            10% { transform: scale(1.1); }
            20% { transform: scale(1); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(1px); }
            75% { transform: translateX(-1px); }
            100% { transform: translateX(0); }
        }

        /* Particles */
        .particle {
            position: fixed; /* absolute„Å†„Å®Ë¶™„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Çã„ÅÆ„ÅßfixedÊé®Â•® */
            width: 10px; height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transition: top 0.8s ease-in-out, left 0.8s ease-in-out;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ü´Ä The Heart</h1>
        <div class="subtitle">"Correcting the Straw Effect."</div>

        <!-- HQ -->
        <div class="hq-container">
            <div class="heart-icon" id="heart-btn">ü´Ä</div>
            <div class="pool-display" id="pool-val">Pool: ¬•0</div>
        </div>

        <!-- Blocks -->
        <div class="blocks-wrapper" id="blocks-area">
            <!-- Generated by Python -->
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" py-click="trigger_gcart">‚ö° Run G-Cart (Optimize)</button>
            <button class="btn" py-click="toggle_decay">‚è∏Ô∏è Pause</button>
        </div>

        <!-- Log -->
        <div id="log-area">System Booted. Watching wealth distribution...</div>
    </div>

    <!-- Python Logic -->
    <script type="py">
        import js
        import asyncio
        import random
        from pyodide.ffi import create_proxy

        # --- Initial Data ---
        # Tokyo: Predator (Âê∏„ÅÜÂÅ¥)
        # Others: Prey (Âê∏„Çè„Çå„ÇãÂÅ¥)
        blocks_data = [
            {"name": "Tokyo",   "hp": 1.00, "type": "predator", "color": "#d600ff"},
            {"name": "Osaka",   "hp": 0.80, "type": "neutral",  "color": "#4b91ff"},
            {"name": "Sendai",  "hp": 0.60, "type": "prey",     "color": "#4b91ff"},
            {"name": "Akita",   "hp": 0.40, "type": "prey",     "color": "#4b91ff"},
            {"name": "Tottori", "hp": 0.20, "type": "prey",     "color": "#4b91ff"},
        ]

        state = {
            "pool": 0,
            "running": True
        }

        # --- UI Generator ---
        def init_ui():
            container = js.document.getElementById("blocks-area")
            container.innerHTML = ""
            
            for i, b in enumerate(blocks_data):
                extra_class = "predator" if b["type"] == "predator" else ""
                
                html = f"""
                <div class="block-card {extra_class}" id="card-{i}">
                    <div class="block-name">{b['name']}</div>
                    <div class="vitality-track">
                        <div class="vitality-fill" id="fill-{i}" style="height: {int(b['hp']*100)}%; background-color: {b['color']};"></div>
                    </div>
                    <div class="block-stats" id="val-{i}">{int(b['hp']*100)}%</div>
                </div>
                """
                container.innerHTML += html

        def log(msg, color=""):
            area = js.document.getElementById("log-area")
            line = f"<div class='log-entry {color}'>{msg}</div>"
            area.innerHTML = line + area.innerHTML

        def update_visuals():
            js.document.getElementById("pool-val").innerText = f"Pool: ¬•{int(state['pool']):,}"
            
            for i, b in enumerate(blocks_data):
                fill = js.document.getElementById(f"fill-{i}")
                val = js.document.getElementById(f"val-{i}")
                card = js.document.getElementById(f"card-{i}")
                
                # HP cap check (Tokyo can go over 100%)
                display_hp = b["hp"]
                if display_hp < 0: display_hp = 0
                
                # Height (Max 100% for CSS)
                css_height = min(100, int(display_hp * 100))
                fill.style.height = f"{css_height}%"
                val.innerText = f"{int(display_hp * 100)}%"
                
                # Color & Style Logic
                if b["type"] == "predator":
                    fill.style.backgroundColor = "#d600ff" # Toxic Purple
                    if b["hp"] > 1.2: # Too fat
                        card.style.borderColor = "#d600ff"
                elif b["hp"] < 0.3:
                    fill.style.backgroundColor = "#ff0000"
                    card.classList.add("critical")
                else:
                    fill.style.backgroundColor = "#4b91ff"
                    card.classList.remove("critical")

        # --- Animation ---
        async def particle_anim(from_id, to_id, color):
            p = js.document.createElement("div")
            p.className = "particle"
            p.style.backgroundColor = color
            p.style.boxShadow = f"0 0 10px {color}"
            
            # Start Coord
            if from_id == "heart":
                start_el = js.document.getElementById("heart-btn")
            else:
                start_el = js.document.getElementById(f"card-{from_id}")
            
            if not start_el: return
            s_rect = start_el.getBoundingClientRect()
            
            # Fixed coordinate correction
            p.style.top = f"{s_rect.top + 20}px"
            p.style.left = f"{s_rect.left + s_rect.width/2}px"
            
            js.document.body.appendChild(p)
            await asyncio.sleep(0.05)
            
            # End Coord
            if to_id == "heart":
                end_el = js.document.getElementById("heart-btn")
            else:
                end_el = js.document.getElementById(f"card-{to_id}")
            
            if not end_el: return
            t_rect = end_el.getBoundingClientRect()
            
            p.style.top = f"{t_rect.top + 20}px"
            p.style.left = f"{t_rect.left + t_rect.width/2}px"
            
            await asyncio.sleep(0.8)
            p.remove()

        # --- The Straw Effect Loop (Reality) ---
        async def straw_effect_loop():
            while True:
                if state["running"]:
                    tokyo = blocks_data[0] # Predator
                    
                    # Âú∞Êñπ„Åã„ÇâÂê∏„ÅÑ‰∏ä„Åí„Çã
                    for i, b in enumerate(blocks_data):
                        if b["type"] == "prey" and b["hp"] > 0:
                            drain = 0.02
                            b["hp"] -= drain
                            
                            # 50%„ÅØÊ∂à„Åà„ÄÅ50%„ÅØÊù±‰∫¨„Å∏ÁßªËª¢„Åô„Çã (Leakage)
                            tokyo["hp"] += drain * 0.5 
                            
                            # Visual: Purple Particle (Prey -> Tokyo)
                            if random.random() > 0.6:
                                asyncio.ensure_future(particle_anim(i, 0, "#d600ff"))
                    
                    # Ëá™ÁÑ∂Ê∏õË°∞ (ÂÖ®‰Ωì)
                    for b in blocks_data:
                        if b["hp"] > 0: b["hp"] -= 0.005

                    update_visuals()
                
                await asyncio.sleep(1.0) # 1Áßí„Çµ„Ç§„ÇØ„É´

        # --- G-Cart Intervention (Solution) ---
        async def trigger_gcart(event):
            # 1. Âæ¥Âèé (Taxing Tokyo)
            tokyo = blocks_data[0]
            tax_revenue = 0
            
            if tokyo["hp"] > 1.0:
                surplus = tokyo["hp"] - 1.0
                tax_revenue = 1000000000 + (surplus * 5000000000)
                tokyo["hp"] = 1.0 # Reset to normal
                
                log(f"üõ°Ô∏è G-Cart: Êù±‰∫¨„ÅÆËÇ•Â§ßÂåñ„ÇíÊ§úÁü•„ÄÇÂØå„ÇíÂÜçÈÖçÂàÜ„Åó„Åæ„Åô„ÄÇ", "c-gold")
                await particle_anim(0, "heart", "#ffd700") # Tokyo -> Heart
            else:
                tax_revenue = 500000000
                log(f"üõ°Ô∏è G-Cart: ÈÄöÂ∏∏Âæ¥Âèé„ÇíÂÆüË°å„ÄÇ", "c-gold")
                await particle_anim(0, "heart", "#ffd700")

            state["pool"] += tax_revenue
            update_visuals()
            await asyncio.sleep(0.5)
            
            # 2. Ëº∏Ë°Ä (Transfusion to Dying Blocks)
            if state["pool"] > 0:
                # HP‰Ωé„ÅÑÈ†Ü
                sorted_indices = sorted(range(len(blocks_data)), key=lambda k: blocks_data[k]["hp"])
                
                count = 0
                for idx in sorted_indices:
                    target = blocks_data[idx]
                    if state["pool"] <= 0: break
                    if target["type"] == "predator": continue
                    if target["hp"] >= 0.9: continue
                    
                    # ÊïëÊ∏àÈ°ç
                    cost = 500000000
                    if state["pool"] < cost: cost = state["pool"]
                    
                    state["pool"] -= cost
                    target["hp"] += 0.25 # ÂõûÂæ©
                    
                    await particle_anim("heart", idx, "#ff4b4b") # Heart -> Local
                    log(f"üíó The Heart: {target['name']} „ÇíÊïëÊ∏à„Åó„Åæ„Åó„Åü„ÄÇ", "c-red")
                    
                    update_visuals()
                    count += 1
                    await asyncio.sleep(0.2)

        def toggle_decay(event):
            state["running"] = not state["running"]

        # --- Main ---
        init_ui()
        update_visuals()
        asyncio.ensure_future(straw_effect_loop())

    </script>
</body>
</html>
