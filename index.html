<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Heart | Global Liquidity Protocol</title>
    <!-- PyScriptã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        body {
            background-color: #0e1117;
            color: #c9d1d9;
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #ff4b4b; text-align: center; }
        .subtitle { text-align: center; color: #8b949e; margin-bottom: 30px; }
        #output {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            white-space: pre-wrap; /* æ”¹è¡Œã‚’ç¶­æŒ */
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 0 20px rgba(255, 75, 75, 0.1);
        }
        .btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background: #ff4b4b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        .btn:hover { background: #ff3333; }
    </style>
</head>
<body>

    <h1>ğŸ«€ The Heart</h1>
    <div class="subtitle">"From Logic to the Heart."</div>

    <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
    <button id="run-btn" class="btn" py-click="run_simulation()">Run Simulation</button>

    <!-- å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
    <div id="output">System Ready... Waiting for trigger.</div>

    <!-- Pythonã‚³ãƒ¼ãƒ‰ (ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹) -->
    <py-script>
        from dataclasses import dataclass
        from typing import List, Tuple
        import js

        # --- System Constants ---
        THRESHOLD_DISTORTION = 10.0
        PROTOCOL_FEE_RATE = 0.1

        # å‡ºåŠ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        def log(text):
            output_div = js.document.getElementById("output")
            # æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆã«è¿½è¨˜ã™ã‚‹ã‹ã€ä¸Šæ›¸ãã™ã‚‹ã‹
            if "System Ready" in output_div.innerText:
                output_div.innerText = text + "\n"
            else:
                output_div.innerText += text + "\n"

        def clear_log():
            js.document.getElementById("output").innerText = ""

        @dataclass
        class StandardBlock:
            id: str
            name: str
            population: int
            wealth: float
            vitality: float
            
            def is_critical(self) -> bool:
                return self.vitality < 0.3 or self.wealth < 10000

            def receive_transfusion(self, amount: float):
                log(f"  [ğŸ’— THE HEART] è¼¸è¡€ã‚’å®Ÿè¡Œ -> Target: {self.name}")
                log(f"    -> ç‰¹åˆ¥ã‚¯ã‚¨ã‚¹ãƒˆç™ºæ³¨: äºˆç®— Â¥{amount:,.0f}")
                
                healing = (amount / 100000000) * 0.1 
                old_vitality = self.vitality
                self.vitality = min(1.0, self.vitality + healing)
                self.wealth += amount
                
                log(f"    -> ãƒã‚¤ã‚¿ãƒ«å›å¾©: {old_vitality:.2f} => {self.vitality:.2f}")
                log(f"    -> åœ°åŸŸå¯Œã®å¢—åŠ : Â¥{self.wealth:,.0f}")

        class Leviathan:
            def attempt_spending(self, target_block: StandardBlock) -> Tuple[float, float]:
                fair_value = 100000000.0
                bloated_budget = 1000000000.0
                return bloated_budget, fair_value

        class GCartValve:
            def check_and_regulate(self, budget: float, fair_value: float, block: StandardBlock) -> Tuple[float, float]:
                distortion = budget / fair_value
                if distortion > THRESHOLD_DISTORTION:
                    log(f"  [ğŸ›¡ï¸ G-CART] ç•°å¸¸æ¤œçŸ¥: æ­ªã¿æŒ‡æ•° {distortion:.1f} (Block: {block.name})")
                    log(f"    -> é®æ–­å¼é–‰é–ã€‚é©æ­£ä¾¡æ ¼ Â¥{fair_value:,.0f} ã«å¼·åˆ¶ä¿®æ­£ã€‚")
                    return fair_value, (budget - fair_value)
                return budget, 0.0

        class TheHeart:
            def __init__(self):
                self.arterial_pool = 0.0

            def diastole(self, saved_wealth: float):
                flow = saved_wealth * PROTOCOL_FEE_RATE
                self.arterial_pool += flow
                log(f"  [ğŸ«€ DIASTOLE] å¾ªç’°ãƒ—ãƒ¼ãƒ«é‚„æµ: +Â¥{flow:,.0f} (Total: Â¥{self.arterial_pool:,.0f})")

            def systole(self, blocks: List[StandardBlock]):
                if self.arterial_pool <= 0:
                    return
                critical_blocks = [b for b in blocks if b.is_critical()]
                if critical_blocks:
                    target = min(critical_blocks, key=lambda b: b.vitality)
                    injection_amount = self.arterial_pool
                    target.receive_transfusion(injection_amount)
                    self.arterial_pool = 0.0
                else:
                    log("  [ğŸ«€ SYSTOLE] å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®å¥å¸¸æ€§ã‚’ç¢ºèªã€‚ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ¸©å­˜ã—ã¾ã™ã€‚")

        def run_simulation(*args):
            clear_log()
            log("==================================================")
            log("   SYSTEM BOOT: The Heart (Global Liquidity Protocol)")
            log("==================================================\n")
            
            world_blocks = [
                StandardBlock("A", "Tokyo-Minato", 200000, 999999999, 0.95),
                StandardBlock("B", "Osaka-Kita",   150000, 50000000, 0.70),
                StandardBlock("C", "Yubari-Like",  6000,   1000,     0.15)
            ]
            
            leviathan = Leviathan()
            valve = GCartValve()
            heart = TheHeart()
            
            log("--- Phase 1: Distortion & Regulation ---")
            target_block = world_blocks[0]
            
            budget, fair = leviathan.attempt_spending(target_block)
            log(f"Target: {target_block.name} | è¡Œæ”¿æç¤ºé¡: Â¥{budget:,.0f}")
            
            paid, saved = valve.check_and_regulate(budget, fair, target_block)
            log(f"-> åŸ·è¡Œé¡: Â¥{paid:,.0f} | æµ®ã„ãŸç¨é‡‘(Surplus): Â¥{saved:,.0f}")
            
            log("\n--- Phase 2: The Heartbeat ---")
            heart.diastole(saved)
            heart.systole(world_blocks)
            
            log("\n==================================================")
            log("   SYSTEM STATUS: Stable. Circulation Optimized.")
            log("==================================================")
    </py-script>
</body>
                </html>
