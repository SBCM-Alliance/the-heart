<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>The Heart | Monitor</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#050505;--card:#111;--text:#e0e0e0;--heart:#ff4b4b;--surplus:#ffd700;}
        body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;padding:20px;}
        header{border-bottom:1px solid #333;padding-bottom:20px;margin-bottom:30px;display:flex;justify-content:space-between;}
        #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;}
        .card{background:var(--card);border:1px solid #333;padding:20px;border-radius:8px;}
        .bloated{color:var(--surplus);} .critical{color:var(--heart);animation:pulse 1s infinite;}
        @keyframes pulse{0%{opacity:1;}50%{opacity:0.5;}100%{opacity:1;}}
    </style>
</head>
<body>
    <header><div><h1>ðŸ«€ The Heart</h1>Serverless Monitor</div><div>POOL: <span id="pool" style="color:var(--surplus);">Â¥0</span></div></header>
    <div id="grid" style="text-align:center;color:#555;">Connecting to Nostr...</div>
    <script type="py">
        from pyscript import document
        import js
        from pyodide.ffi import create_proxy
        
        blocks = {}
        
        def update():
            h=""; tax=0
            for c,d in blocks.items():
                avg=sum(d)/len(d); st="NORMAL"; cl=""
                if avg>10: st="BLOATED"; cl="bloated"; tax+=int(avg*10000)
                elif len(d)<3: st="CRITICAL"; cl="critical"
                h+=f'<div class="card"><h3>{c}</h3>Reports: {len(d)}<br>D_index: {avg:.1f}<br><span class="{cl}">{st}</span></div>'
            document.getElementById("grid").innerHTML=h
            document.getElementById("pool").innerText=f"Â¥{tax:,}"

        def on_event(ev):
            tags=ev.tags; city="Unknown"; val=0
            for t in tags:
                if t[0]=='t' and t[1]!='SBCM_AUDIT': city=t[1]
                if t[0]=='d': val=float(t[1])
            if city!="Unknown":
                if city not in blocks: blocks[city]=[]
                blocks[city].append(val)
                update()

        async def main():
            pool=js.window.NostrTools.SimplePool.new(); cb=create_proxy(on_event)
            pool.subscribe(['wss://relay.damus.io','wss://nos.lol'], [{"kinds":[1],"#t":["SBCM_AUDIT"]}]).on("event",cb)
            # Demo Data
            on_event(type('obj',(object,),{"tags":[["t","SBCM_AUDIT"],["t","Minato-ku"],["d","150.0"]]}))
        main()
    </script>
</body>
</html>
