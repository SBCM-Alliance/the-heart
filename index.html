<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Heart | Visual Dashboard</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* --- Cyberpunk UI Styles --- */
        body {
            background-color: #050505;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: #ff4b4b; margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        .subtitle { color: #666; font-size: 0.8rem; margin-bottom: 20px; }

        /* --- Layout --- */
        .container {
            width: 100%;
            max-width: 600px;
            position: relative;
        }

        /* --- Top: HQ (The Heart) --- */
        .hq-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        .heart-icon {
            font-size: 3rem;
            animation: heartbeat 1.5s infinite;
            cursor: pointer;
            z-index: 2;
        }

        .pool-display {
            background: #1a1a1a;
            border: 1px solid #ff4b4b;
            padding: 5px 15px;
            border-radius: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            color: #ff4b4b;
            box-shadow: 0 0 10px rgba(255, 75, 75, 0.3);
        }

        /* --- Bottom: Blocks --- */
        .blocks-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
        }

        .block-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            width: 30%;
            text-align: center;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .block-card:hover { transform: translateY(-5px); border-color: #666; }
        .block-card.critical { border-color: #ff4b4b; box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }

        .block-name { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        .block-vitality-bar {
            height: 100px;
            background: #222;
            width: 20px;
            margin: 0 auto;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }

        .vitality-fill {
            background: linear-gradient(to top, #4b91ff, #00d2ff);
            width: 100%;
            position: absolute;
            bottom: 0;
            transition: height 0.5s ease-out;
        }
        
        .block-card.critical .vitality-fill { background: linear-gradient(to top, #550000, #ff0000); }

        .block-stats { font-size: 0.7rem; color: #888; margin-top: 5px; font-family: monospace; }

        /* --- Animations --- */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); text-shadow: 0 0 20px red; }
            100% { transform: scale(1); }
        }

        .flow-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff4b4b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4b4b;
            pointer-events: none;
            z-index: 100;
            transition: top 1s ease-in, left 1s ease-in;
        }

        /* Log Area */
        #log-area {
            margin-top: 30px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.7rem;
            color: #666;
            border-top: 1px solid #333;
            padding-top: 10px;
            width: 100%;
            font-family: monospace;
        }
        
        .log-entry { margin-bottom: 2px; }
        .log-red { color: #ff4b4b; }
        .log-gold { color: #ffd700; }

        /* Buttons */
        .controls { margin-top: 20px; display: flex; gap: 10px; }
        .btn {
            background: #333; border: 1px solid #555; color: white;
            padding: 8px 16px; cursor: pointer; border-radius: 4px;
        }
        .btn:hover { background: #444; }
        .btn-primary { background: #ff4b4b; border-color: #ff4b4b; }
        .btn-primary:hover { background: #d43f3f; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ü´Ä The Heart</h1>
        <div class="subtitle">"From Logic to the Heart."</div>

        <!-- HQ Area -->
        <div class="hq-container" id="hq">
            <div class="heart-icon" id="heart-btn">ü´Ä</div>
            <div class="pool-display" id="pool-val">Pool: ¬•0</div>
        </div>

        <!-- Blocks Area -->
        <div class="blocks-container" id="blocks-area">
            <div class="block-card" id="block-0" py-click="manual_transfusion(0)">
                <div class="block-name">Tokyo</div>
                <div class="block-vitality-bar"><div class="vitality-fill" id="fill-0" style="height: 95%;"></div></div>
                <div class="block-stats" id="stats-0">HP: 95%</div>
            </div>
            <div class="block-card" id="block-1" py-click="manual_transfusion(1)">
                <div class="block-name">Osaka</div>
                <div class="block-vitality-bar"><div class="vitality-fill" id="fill-1" style="height: 70%;"></div></div>
                <div class="block-stats" id="stats-1">HP: 70%</div>
            </div>
            <div class="block-card critical" id="block-2" py-click="manual_transfusion(2)">
                <div class="block-name">Yubari</div>
                <div class="block-vitality-bar"><div class="vitality-fill" id="fill-2" style="height: 15%;"></div></div>
                <div class="block-stats" id="stats-2">HP: 15%</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" py-click="run_cycle">‚ö° Run Cycle (G-Cart)</button>
            <button class="btn" py-click="reset_system">Reset</button>
        </div>

        <div id="log-area">System Ready... Tap specific block to inject funds manually.</div>
    </div>

    <!-- Python Logic -->
    <script type="py">
        import js
        import random
        import asyncio

        # --- System State ---
        state = {
            "pool": 0,
            "blocks": [
                {"name": "Tokyo", "hp": 0.95, "wealth": 900000000},
                {"name": "Osaka", "hp": 0.70, "wealth": 50000000},
                {"name": "Yubari", "hp": 0.15, "wealth": 1000}
            ]
        }

        # --- Helper Functions ---
        def log(msg, color=""):
            log_area = js.document.getElementById("log-area")
            span = f"<div class='log-entry {color}'>{msg}</div>"
            log_area.innerHTML = span + log_area.innerHTML

        def update_ui():
            # Update Pool
            js.document.getElementById("pool-val").innerText = f"Pool: ¬•{int(state['pool']):,}"
            
            # Update Blocks
            for i, b in enumerate(state["blocks"]):
                fill = js.document.getElementById(f"fill-{i}")
                stats = js.document.getElementById(f"stats-{i}")
                card = js.document.getElementById(f"block-{i}")
                
                # HP Limit
                if b['hp'] > 1.0: b['hp'] = 1.0
                
                # Height
                fill.style.height = f"{int(b['hp'] * 100)}%"
                stats.innerText = f"HP: {int(b['hp'] * 100)}%"
                
                # Critical styling
                if b['hp'] < 0.3:
                    card.classList.add("critical")
                else:
                    card.classList.remove("critical")

        async def animate_flow(target_index):
            # Create particle
            particle = js.document.createElement("div")
            particle.className = "flow-particle"
            
            # Start position (HQ)
            hq_rect = js.document.getElementById("heart-btn").getBoundingClientRect()
            particle.style.top = f"{hq_rect.top + 20}px"
            particle.style.left = f"{hq_rect.left + 20}px"
            
            js.document.body.appendChild(particle)
            
            # Wait a bit for DOM rendering
            await asyncio.sleep(0.05)
            
            # End position (Target Block)
            target = js.document.getElementById(f"block-{target_index}")
            target_rect = target.getBoundingClientRect()
            
            # Move
            particle.style.top = f"{target_rect.top + 20}px"
            particle.style.left = f"{target_rect.left + target_rect.width/2}px"
            
            # Wait for animation to finish
            await asyncio.sleep(1.0)
            
            # Cleanup
            particle.remove()

        # --- Core Logic ---

        async def run_cycle(event):
            # 1. Leviathan (Distortion)
            target_idx = random.randint(0, 1) # Êù±‰∫¨„ÅãÂ§ßÈò™„Åß‰∫àÁÆóÁô∫Áîü
            budget = 1000000000 # 10ÂÑÑ
            fair = 100000000    # 1ÂÑÑ
            
            log(f"--- ‰∫àÁÆóÂü∑Ë°å: {state['blocks'][target_idx]['name']} (ÊèêÁ§∫: ¬•10ÂÑÑ) ---")
            
            # 2. G-Cart (Optimization)
            distortion = budget / fair
            saved = 0
            if distortion > 9.9:
                log(f"üõ°Ô∏è G-CART: Ê≠™„Åø {distortion:.1f} „ÇíÊ§úÁü•! 9ÂÑÑÂÜÜ„Çí„Ç´„ÉÉ„Éà„ÄÇ", "log-gold")
                saved = budget - fair
            
            # 3. The Heart (Collection)
            fee = saved * 0.3 # 30%„Éó„Éº„É´
            state["pool"] += fee
            log(f"ü´Ä HQ: ¬•{int(fee):,} „Çí„Éó„Éº„É´„Åó„Åæ„Åó„Åü„ÄÇ")
            
            update_ui()
            
            # 4. Auto-Distribution (Systole) if critical exists
            crit_idx = -1
            min_hp = 1.0
            for i, b in enumerate(state["blocks"]):
                if b["hp"] < 0.3 and b["hp"] < min_hp:
                    min_hp = b["hp"]
                    crit_idx = i
            
            if crit_idx != -1 and state["pool"] > 0:
                await manual_transfusion(crit_idx)

        async def manual_transfusion(block_idx):
            # „Çø„ÉÉ„Éó„Åæ„Åü„ÅØËá™ÂãïÂÆüË°å„ÅßÂëº„Å∞„Çå„Çã
            if state["pool"] <= 0:
                log("‚ö†Ô∏è „Éó„Éº„É´ÊÆãÈ´ò„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇG-Cart„ÇíÂõû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")
                return

            block = state["blocks"][block_idx]
            amount = state["pool"]
            
            # Animation (Async wait)
            await animate_flow(block_idx)
            
            log(f"üíó Ëº∏Ë°ÄÂÆüË°å: {block['name']} „Å∏ ¬•{int(amount):,} (ÁâπÂà•„ÇØ„Ç®„Çπ„Éà)", "log-red")
            
            # Logic
            heal = 0.25
            block["hp"] = min(1.0, block["hp"] + heal)
            state["pool"] = 0
            
            # UI update
            update_ui()

        def reset_system(event):
            state["pool"] = 0
            state["blocks"][0]["hp"] = 0.95
            state["blocks"][1]["hp"] = 0.70
            state["blocks"][2]["hp"] = 0.15
            update_ui()
            log("System Reset.")

    </script>
</body>
</html>
